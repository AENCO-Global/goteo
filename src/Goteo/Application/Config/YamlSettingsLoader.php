<?php

namespace Goteo\Application\Config;

use Symfony\Component\Config\ConfigCache;
use Symfony\Component\Config\Loader\FileLoader;
use Symfony\Component\Yaml\Yaml;

use Goteo\Application\App;

class YamlSettingsLoader extends FileLoader
{
    public function load($resource, $type = null)
    {
        // Cached resources ?
        $cachePath = GOTEO_CACHE_PATH . 'appConfig.php';

        // the second argument indicates whether or not you want to use debug mode
        $cacheMatcher = new ConfigCache($cachePath, App::debug());

        if (!$cacheMatcher->isFresh()) {
            // Get config from yaml
            $config = Yaml::parse(file_get_contents($resource));

            //Code in PHP
            $code = "<?php\n".
              "// auto-generated by %s\n".
              "// date: %s\nreturn %s;\n";
            $code = sprintf($code, __CLASS__, date('Y/m/d H:i:s'), var_export($config, true));

            $cacheMatcher->write($code, $resources);

        }

        // you may want to require the cached code:
        return require $cachePath;

        // return $config;
    }

    public function supports($resource, $type = null)
    {
        return is_string($resource) && 'yml' === pathinfo(
            $resource,
            PATHINFO_EXTENSION
        );
    }
}
